name: Comprehensive CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run shellcheck
        run: shellcheck sysinfo.sh

  test-matrix:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, fedora-latest]
        # We can add more services to the matrix as needed
        firewall: [ufw, firewalld]
        timesync: [chrony, ntp]
    
    steps:
      - uses: actions/checkout@v3
      - name: Install Dependencies & Setup Environment
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            sudo apt-get update
            sudo apt-get install -y iproute2 procps wget gnupg lsb-release ca-certificates ufw firewalld chrony ntp docker.io podman
          elif [[ "${{ matrix.os }}" == "fedora-latest" ]]; then
            sudo dnf install -y iproute procps-ng wget lsb-release ufw firewalld chrony ntp podman
            # Install Docker on Fedora
            sudo dnf -y install dnf-plugins-core
            sudo dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
            sudo dnf -y install docker-ce docker-ce-cli containerd.io
          fi
        
      - name: Configure and Test Firewall
        run: |
          # Disable all firewalls first
          sudo systemctl disable --now ufw 2>/dev/null || true
          sudo systemctl disable --now firewalld 2>/dev/null || true
          
          # Enable the one from the matrix
          if [[ "${{ matrix.firewall }}" == "ufw" && "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            sudo ufw enable
            bash sysinfo.sh --core | grep -i "ufw"
          elif [[ "${{ matrix.firewall }}" == "firewalld" ]]; then
            sudo systemctl enable --now firewalld
            bash sysinfo.sh --core | grep -i "firewalld"
          fi

      - name: Configure and Test Time Sync
        run: |
          # Disable all time sync services first
          sudo systemctl disable --now chrony 2>/dev/null || true
          sudo systemctl disable --now ntp 2>/dev/null || true
          sudo systemctl disable --now systemd-timesyncd 2>/dev/null || true

          # Enable the one from the matrix
          sudo systemctl enable --now ${{ matrix.timesync }}
          bash sysinfo.sh --core | grep -i "${{ matrix.timesync }}"

      - name: Run Full Script
        run: |
          echo "--- Running full script ---"
          bash sysinfo.sh
          
          echo "--- Testing individual sections ---"
          bash sysinfo.sh --system
          bash sysinfo.sh --hardware
          bash sysinfo.sh --net

  test-alpine:
    name: Test on Alpine Linux
    runs-on: ubuntu-latest
    container: alpine:latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Dependencies
        run: apk add --no-cache bash coreutils procps iproute2 util-linux
      - name: Run Script
        run: |
          echo "--- Running full script on Alpine ---"
          bash sysinfo.sh
          echo "--- Grepping for Alpine-specifics ---"
          bash sysinfo.sh --packages | grep -i "apk"

  test-systemd-free:
    name: Test on systemd-free (Debian 10)
    runs-on: ubuntu-latest
    container: debian:10
    steps:
      - uses: actions/checkout@v3
      - name: Install Dependencies
        run: |
          apt-get update
          apt-get install -y procps iproute2 lsb-release wget
      - name: Run Script and Check for SysVinit
        run: |
          echo "--- Running full script on Debian 10 (SysVinit) ---"
          bash sysinfo.sh
          echo "--- Checking for SysVinit ---"
          bash sysinfo.sh --core | grep -i "SysVinit"
