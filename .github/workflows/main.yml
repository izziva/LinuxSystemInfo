name: Comprehensive CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: Run shellcheck
        run: shellcheck sysinfo.sh

  test-matrix:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04]
        # We can add more services to the matrix as needed
        firewall: [ufw, firewalld]
        timesync: [chrony, ntp]
    
    steps:
      - uses: actions/checkout@v3
      - name: Install Dependencies & Setup Environment
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-22.04" ]]; then
            sudo apt-get update
            # Install base packages
            sudo apt-get install -y iproute2 procps wget gnupg lsb-release ca-certificates podman
            # Install conflicting packages based on the matrix
            sudo apt-get install -y ${{ matrix.firewall }}
            sudo apt-get install -y ${{ matrix.timesync }}
          fi
        
      - name: Configure and Test Firewall
        run: |
          # Disable all firewalls first
          sudo systemctl disable --now ufw 2>/dev/null || true
          sudo systemctl disable --now firewalld 2>/dev/null || true
          
          # Enable the one from the matrix
          if [[ "${{ matrix.firewall }}" == "ufw" && "${{ matrix.os }}" == "ubuntu-22.04" ]]; then
            sudo ufw --force enable
            bash sysinfo.sh --core | grep -i "ufw"
          elif [[ "${{ matrix.firewall }}" == "firewalld" ]]; then
            sudo systemctl enable --now firewalld
            bash sysinfo.sh --core | grep -i "firewalld"
          fi

      - name: Configure and Test Time Sync
        run: |
          # Disable all time sync services first
          sudo systemctl disable --now chrony 2>/dev/null || true
          sudo systemctl disable --now ntp 2>/dev/null || true
          sudo systemctl disable --now systemd-timesyncd 2>/dev/null || true

          # Enable the one from the matrix
          sudo systemctl enable --now ${{ matrix.timesync }}
          bash sysinfo.sh --core | grep -i "${{ matrix.timesync }}"

      - name: Run Full Script
        run: |
          echo "--- Running full script ---"
          bash sysinfo.sh
          
          echo "--- Testing individual sections ---"
          bash sysinfo.sh --system
          bash sysinfo.sh --hardware
          bash sysinfo.sh --net

  test-fedora:
    name: Test on Fedora
    runs-on: ubuntu-22.04
    container: fedora:latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Dependencies
        run: |
          dnf install -y iproute procps-ng wget lsb-release
      - name: Run Script
        run: |
          echo "--- Running full script on Fedora ---"
          bash sysinfo.sh
          echo "--- Grepping for Fedora-specifics ---"
          bash sysinfo.sh --packages | grep -i "dnf"

  test-alpine:
    name: Test on Alpine Linux
    runs-on: ubuntu-22.04
    container: alpine:latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Dependencies
        run: apk add --no-cache bash coreutils procps iproute2 util-linux
      - name: Run Script
        run: |
          echo "--- Running full script on Alpine ---"
          bash sysinfo.sh
          echo "--- Grepping for Alpine-specifics ---"
          bash sysinfo.sh --packages | grep -i "apk"

  test-systemd-free:
    name: Test on systemd-free (Debian 10)
    runs-on: ubuntu-22.04
    container: debian:10
    steps:
      - uses: actions/checkout@v3
      - name: Install Dependencies
        run: |
          echo "deb http://archive.debian.org/debian/ buster main" > /etc/apt/sources.list
          echo "deb http://archive.debian.org/debian-security/ buster/updates main" >> /etc/apt/sources.list
          apt-get update
          apt-get install -y procps iproute2 lsb-release wget
      - name: Run Script and Check for SysVinit
        run: |
          echo "--- Running full script on Debian 10 (SysVinit) ---"
          bash sysinfo.sh
          echo "--- Checking for SysVinit ---"
          bash sysinfo.sh --core | grep -i "SysVinit"
